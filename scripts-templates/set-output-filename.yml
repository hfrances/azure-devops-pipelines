parameters:
  - name: workingDirectory
    type: string
    default: '$(Build.SourcesDirectory)'

steps:
  - task: PowerShell@2
    inputs:
      pwsh: true
      targetType: 'inline'
      script: |
        # Set package full name.
        $packageName = "$(MainProject.PackageName)";
        $version = "$(BuildParameters.DockerVersion)";
        if ($version) {
          $sufix = ".v$version";
        }
        else {
          $sufix = "";
        }
        write-output "Output filename: $packageName$sufix.tar.gz";
        write-output "##vso[task.setvariable variable=BuildParameters.OutputFile]$packageName$sufix.tar.gz";
        
        # Set output directory
        if ($env:BUILDPARAMETERS_OUTPUTDIRECTORY -eq '<dir>')
        {
          $outputDirectory = Join-Path $env:BUILD_ARTIFACTSTAGINGDIRECTORY "output" (Split-Path "$env:BUILDPARAMETERS_DIRECTORY" -Leaf);
        }
        elseif ($env:BUILDPARAMETERS_OUTPUTDIRECTORY) {
          $outputDirectory = Join-Path $env:BUILD_ARTIFACTSTAGINGDIRECTORY "output" $env:BUILDPARAMETERS_OUTPUTDIRECTORY;
        }
        else {
          $outputDirectory = Join-Path $env:BUILD_ARTIFACTSTAGINGDIRECTORY "output";
        }
        write-output "##vso[task.setvariable variable=BuildParameters.OutputDirectory]$outputDirectory";
      workingDirectory: '${{ parameters.workingDirectory }}'
    displayName: 'Set output filename'